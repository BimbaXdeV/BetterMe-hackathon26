Index: server/main.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import sys\r\nimport os\r\nimport asyncio\r\nfrom datetime import datetime\r\nfrom typing import List, Optional\r\nfrom pydantic import BaseModel\r\nfrom fastapi import FastAPI, HTTPException\r\nfrom fastapi.middleware.cors import CORSMiddleware\r\nimport uvicorn\r\n\r\n# --- МОДЕЛИ ---\r\nclass Order(BaseModel):\r\n    latitude: float\r\n    longitude: float\r\n    subtotal: float\r\n    timestamp: Optional[datetime] = None\r\n\r\nclass OrderResponse(Order):\r\n    id: int\r\n    composite_tax_rate: float\r\n    tax_amount: float\r\n    total_amount: float\r\n    state_rate: float\r\n    county_rate: float\r\n    city_rate: float\r\n    special_rates: float\r\n    jurisdictions: Optional[str] = None\r\n\r\n# --- ИМПОРТ СЕРВИСА ---\r\ntry:\r\n    from tax_service import calculate_order_tax\r\nexcept ImportError:\r\n    sys.path.append(os.path.dirname(os.path.abspath(__file__)))\r\n    from tax_service import calculate_order_tax\r\n\r\napp = FastAPI(title=\"BetterMe Tax API\")\r\n\r\napp.add_middleware(\r\n    CORSMiddleware,\r\n    allow_origins=[\"*\"],\r\n    allow_credentials=True,\r\n    allow_methods=[\"*\"],\r\n    allow_headers=[\"*\"],\r\n)\r\n\r\norders_db = []\r\n\r\n@app.get('/')\r\ndef root():\r\n    return {'status': 'BetterMe API is running', 'orders_count': len(orders_db)}\r\n\r\n@app.get('/orders', response_model=List[OrderResponse])\r\nasync def get_orders():\r\n    return orders_db\r\n\r\n@app.post('/orders', response_model=OrderResponse)\r\nasync def create_order(order: Order):\r\n    try:\r\n        tax_data = await calculate_order_tax(order.latitude, order.longitude, order.subtotal)\r\n        \r\n        new_order_data = {\r\n            \"id\": len(orders_db) + 1,\r\n            \"latitude\": order.latitude,\r\n            \"longitude\": order.longitude,\r\n            \"subtotal\": order.subtotal,\r\n            \"timestamp\": order.timestamp or datetime.now(),\r\n            \"composite_tax_rate\": tax_data[\"composite_tax_rate\"],\r\n            \"tax_amount\": tax_data[\"tax_amount\"],\r\n            \"total_amount\": tax_data[\"total_amount\"],\r\n            \"state_rate\": tax_data[\"breakdown\"][\"state_rate\"],\r\n            \"county_rate\": tax_data[\"breakdown\"][\"county_rate\"],\r\n            \"city_rate\": tax_data[\"breakdown\"][\"city_rate\"],\r\n            \"special_rates\": tax_data[\"breakdown\"][\"special_rates\"],\r\n            \"jurisdictions\": \", \".join(tax_data[\"jurisdictions\"])\r\n        }\r\n        orders_db.append(new_order_data)\r\n        return new_order_data\r\n    except Exception as e:\r\n        print(f\"Error creating order: {e}\")\r\n        raise HTTPException(status_code=500, detail=str(e))\r\n\r\n@app.post('/orders/bulk', response_model=List[OrderResponse])\r\nasync def create_orders_bulk(orders: List[Order]):\r\n    \"\"\"\r\n    Ускоренная обработка больших файлов.\r\n    Обрабатывает заказы пачками по 50 штук одновременно.\r\n    \"\"\"\r\n    print(f\"--- Начинаю импорт {len(orders)} строк ---\")\r\n    \r\n    results = []\r\n    chunk_size = 50  # Размер пачки для параллельной обработки\r\n    \r\n    for i in range(0, len(orders), chunk_size):\r\n        chunk = orders[i : i + chunk_size]\r\n        \r\n        # Создаем список задач для текущей пачки\r\n        tasks = [calculate_order_tax(o.latitude, o.longitude, o.subtotal) for o in chunk]\r\n        \r\n       \r\n        chunk_results = await asyncio.gather(*tasks, return_exceptions=True)\r\n        \r\n        for order, tax_data in zip(chunk, chunk_results):\r\n            if isinstance(tax_data, Exception):\r\n                continue\r\n            \r\n            new_id = len(orders_db) + 1\r\n            processed_order = {\r\n                \"id\": new_id,\r\n                \"latitude\": order.latitude,\r\n                \"longitude\": order.longitude,\r\n                \"subtotal\": order.subtotal,\r\n                \"timestamp\": order.timestamp or datetime.now(),\r\n                \"composite_tax_rate\": tax_data[\"composite_tax_rate\"],\r\n                \"tax_amount\": tax_data[\"tax_amount\"],\r\n                \"total_amount\": tax_data[\"total_amount\"],\r\n                \"state_rate\": tax_data[\"breakdown\"][\"state_rate\"],\r\n                \"county_rate\": tax_data[\"breakdown\"][\"county_rate\"],\r\n                \"city_rate\": tax_data[\"breakdown\"][\"city_rate\"],\r\n                \"special_rates\": tax_data[\"breakdown\"][\"special_rates\"],\r\n                \"jurisdictions\": \", \".join(tax_data[\"jurisdictions\"])\r\n            }\r\n            orders_db.append(processed_order)\r\n            results.append(processed_order)\r\n        \r\n        print(f\"Обработано: {min(i + chunk_size, len(orders))} из {len(orders)}\")\r\n\r\n    print(f\"--- Импорт завершен. Всего в базе: {len(orders_db)} ---\")\r\n    return results\r\n\r\nif __name__ == \"__main__\":\r\n    uvicorn.run(app, host=\"127.0.0.1\", port=8000)
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/server/main.py b/server/main.py
--- a/server/main.py	(revision 69b9b7a4c594162c9a45a1b08a1597315cbb3172)
+++ b/server/main.py	(date 1771881266608)
@@ -27,11 +27,11 @@
     jurisdictions: Optional[str] = None
 
 # --- ИМПОРТ СЕРВИСА ---
-try:
+"""try:
     from tax_service import calculate_order_tax
 except ImportError:
     sys.path.append(os.path.dirname(os.path.abspath(__file__)))
-    from tax_service import calculate_order_tax
+    from tax_service import calculate_order_tax"""
 
 app = FastAPI(title="BetterMe Tax API")
 
