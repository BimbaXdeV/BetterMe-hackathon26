Index: server/main.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import sys\r\nimport os\r\nimport asyncio\r\nimport pandas as pd\r\nfrom datetime import datetime\r\nfrom typing import List, Optional, Union, Dict, Any\r\nfrom pydantic import BaseModel\r\nfrom fastapi import FastAPI, HTTPException, Query\r\nfrom fastapi.middleware.cors import CORSMiddleware\r\nimport uvicorn\r\n\r\n# --- МОДЕЛИ ---\r\nclass Order(BaseModel):\r\n    latitude: float\r\n    longitude: float\r\n    subtotal: float\r\n    timestamp: Optional[Union[datetime, str]] = None\r\n\r\nclass TaxBreakdown(BaseModel):\r\n    state_rate: float\r\n    county_rate: float\r\n    city_rate: float\r\n    special_rates: float\r\n\r\nclass OrderResponse(Order):\r\n    id: int\r\n    composite_tax_rate: float\r\n    tax_amount: float\r\n    total_amount: float\r\n    state_rate: float\r\n    county_rate: float\r\n    city_rate: float\r\n    special_rates: float\r\n    jurisdictions: Optional[str] = None\r\n    breakdown: Optional[TaxBreakdown] = None\r\n\r\n# Модель для ответа с пагинацией\r\nclass PaginatedOrdersResponse(BaseModel):\r\n    orders: List[OrderResponse]\r\n    total: int\r\n    page: int\r\n    limit: int\r\n    total_pages: int\r\n\r\n# --- ИМПОРТЫ ЛОГИКИ ---\r\ntry:\r\n    from tax_service import calculate_order_tax, calculate_bulk_taxes\r\nexcept ImportError:\r\n    sys.path.append(os.path.dirname(os.path.abspath(__file__)))\r\n    from tax_service import calculate_order_tax, calculate_bulk_taxes\r\n\r\napp = FastAPI(title=\"BetterMe Tax API\")\r\n\r\napp.add_middleware(\r\n    CORSMiddleware,\r\n    allow_origins=[\"*\"],\r\n    allow_credentials=True,\r\n    allow_methods=[\"*\"],\r\n    allow_headers=[\"*\"],\r\n)\r\n\r\n# имитация БД\r\norders_db = []\r\n\r\n@app.get('/')\r\ndef root():\r\n    \"\"\"Возвращает общую статистику по всей базе заказов.\"\"\"\r\n    total_tax = sum(o[\"tax_amount\"] for o in orders_db)\r\n    total_revenue = sum(o[\"total_amount\"] for o in orders_db)\r\n    \r\n    return {\r\n        'status': 'BetterMe API is running', \r\n        'orders_count': len(orders_db),\r\n        'total_tax': round(total_tax, 2),\r\n        'total_revenue': round(total_revenue, 2)\r\n    }\r\n\r\n@app.get('/orders', response_model=PaginatedOrdersResponse)\r\nasync def get_orders(\r\n    page: int = Query(1, ge=1, description=\"Номер страницы\"),\r\n    limit: int = Query(50, ge=1, le=100, description=\"Количество заказов на страницу\"),\r\n    county: Optional[str] = None,\r\n    min_subtotal: Optional[float] = None,\r\n    min_tax: Optional[float] = None,\r\n    min_rate: Optional[float] = None\r\n):\r\n    df = pd.DataFrame(orders_db)\r\n\r\n    # Создаем маску (набор условий)\r\n    mask = True\r\n\r\n    if None != county:\r\n        mask &= df['jurisdictions'].str.contains(county)\r\n    if None != min_subtotal:\r\n        mask &= df['subtotal'] >= min_subtotal\r\n    if None != min_tax:\r\n        mask &= df['tax_amount'] >= min_tax\r\n    if None != min_rate:\r\n        mask &= df['composite_tax_rate'] >= min_rate\r\n\r\n    try:\r\n        filtered_orders = df[mask].to_dict('records')\r\n    except:\r\n        filtered_orders = orders_db\r\n\r\n    \"\"\"Получение списка заказов с пагинацией.\"\"\"\r\n    total_count = len(filtered_orders)\r\n    start = (page - 1) * limit\r\n    end = start + limit\r\n    \r\n    paginated_items = filtered_orders[start:end]\r\n    total_pages = (total_count + limit - 1) // limit if total_count > 0 else 1\r\n\r\n    return {\r\n        \"orders\": paginated_items,\r\n        \"total\": total_count,\r\n        \"page\": page,\r\n        \"limit\": limit,\r\n        \"total_pages\": total_pages\r\n    }\r\n\r\n@app.post('/orders', response_model=OrderResponse)\r\nasync def create_order(order: Order):\r\n    \"\"\"Создание одного заказа (из ручной формы).\"\"\"\r\n    try:\r\n        tax_data = await calculate_order_tax(order.latitude, order.longitude, order.subtotal)\r\n        order_time = order.timestamp if isinstance(order.timestamp, datetime) else datetime.now()\r\n\r\n        new_order_data = {\r\n            \"id\": len(orders_db) + 1,\r\n            \"latitude\": order.latitude,\r\n            \"longitude\": order.longitude,\r\n            \"subtotal\": order.subtotal,\r\n            \"timestamp\": order_time,\r\n            \"composite_tax_rate\": tax_data[\"composite_tax_rate\"],\r\n            \"tax_amount\": tax_data[\"tax_amount\"],\r\n            \"total_amount\": tax_data[\"total_amount\"],\r\n            \"state_rate\": tax_data[\"breakdown\"][\"state_rate\"],\r\n            \"county_rate\": tax_data[\"breakdown\"][\"county_rate\"],\r\n            \"city_rate\": tax_data[\"breakdown\"][\"city_rate\"],\r\n            \"special_rates\": tax_data[\"breakdown\"][\"special_rates\"],\r\n            \"breakdown\": tax_data[\"breakdown\"],\r\n            \"jurisdictions\": \", \".join(tax_data[\"jurisdictions\"])\r\n        }\r\n        orders_db.append(new_order_data)\r\n        return new_order_data\r\n    except Exception as e:\r\n        raise HTTPException(status_code=500, detail=str(e))\r\n\r\n@app.post('/orders/import', response_model=List[OrderResponse])\r\nasync def import_orders(orders: List[Order]):\r\n    \r\n    print(f\"--- Старт импорта (ТЗ: /orders/import): {len(orders)} строк ---\")\r\n    start_time = datetime.now()\r\n    \r\n    orders_list = [o.dict() for o in orders]\r\n    \r\n    try:\r\n        all_tax_data = await calculate_bulk_taxes(orders_list)\r\n    except Exception as e:\r\n        print(f\"Ошибка в bulk-обработке: {e}\")\r\n        raise HTTPException(status_code=500, detail=str(e))\r\n\r\n    final_results = []\r\n    for order_obj, tax_data in zip(orders, all_tax_data):\r\n        order_time = order_obj.timestamp if isinstance(order_obj.timestamp, datetime) else datetime.now()\r\n        \r\n        \r\n        processed_order = {\r\n            \"id\": len(orders_db) + 1,\r\n            \"latitude\": order_obj.latitude,\r\n            \"longitude\": order_obj.longitude,\r\n            \"subtotal\": order_obj.subtotal,\r\n            \"timestamp\": order_time,\r\n            \"composite_tax_rate\": tax_data[\"composite_tax_rate\"], \r\n            \"tax_amount\": tax_data[\"tax_amount\"],                \r\n            \"total_amount\": tax_data[\"total_amount\"],           \r\n            \"breakdown\": tax_data[\"breakdown\"],                  \r\n            \"state_rate\": tax_data[\"breakdown\"][\"state_rate\"],\r\n            \"county_rate\": tax_data[\"breakdown\"][\"county_rate\"],\r\n            \"city_rate\": tax_data[\"breakdown\"][\"city_rate\"],\r\n            \"special_rates\": tax_data[\"breakdown\"][\"special_rates\"],\r\n        \r\n            \"jurisdictions\": \", \".join(tax_data[\"jurisdictions\"])\r\n        }\r\n        orders_db.append(processed_order)\r\n        final_results.append(processed_order)\r\n\r\n    duration = (datetime.now() - start_time).total_seconds()\r\n    print(f\"--- Успешно! Импорт по ТЗ завершен за {duration:.2f} сек. ---\")\r\n    return final_results\r\n\r\nif __name__ == \"__main__\":\r\n    uvicorn.run(app, host=\"127.0.0.1\", port=8000)
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/server/main.py b/server/main.py
--- a/server/main.py	(revision e8067359ea626d992d563f3e030867dd2a04713a)
+++ b/server/main.py	(date 1771962075513)
@@ -67,9 +67,9 @@
     """Возвращает общую статистику по всей базе заказов."""
     total_tax = sum(o["tax_amount"] for o in orders_db)
     total_revenue = sum(o["total_amount"] for o in orders_db)
-    
+
     return {
-        'status': 'BetterMe API is running', 
+        'status': 'BetterMe API is running',
         'orders_count': len(orders_db),
         'total_tax': round(total_tax, 2),
         'total_revenue': round(total_revenue, 2)
